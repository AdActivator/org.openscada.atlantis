<?xml version="1.0"?>
<!-- ====================================================================== 
     OpenSCADA Atlantis Build Tools File    
     Providing common build targets for all other ant-scripts
                   
	 Jens Reimann <jens.reimann@inavare.net>
     ====================================================================== -->

<project name="tools" default="default">
    <description>
    	Providing common build targets for all other ant-scripts
    </description>

	<import file="libs.xml"/>
	<import file="append-line.xml"/>
	
	<property name="datadir" location="${ant.file.tools}/../data"/>
	
	<!-- ================================= 
          target: default              
         ================================= -->
    <target name="default" description="--> Nothing">
    </target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          macrodef: openscada.pull-in-lib
          Unpack a deployed archive and copy the libraries into the build-lib folder
         - - - - - - - - - - - - - - - - - -->
    <macrodef name="openscada.pull-in-lib">
    	<attribute name="name"/>
    	<sequential>
	    	<mkdir dir="${build.dir}/${package}/lib"/>
	    	<mkdir dir="${build.dir}/${package}/bin"/>
	    	<unzip src="${deploy.dist.module}/@{name}.zip" dest="${build.dir}/${package}">
	    		<patternset>
	    			<include name="lib/*.jar"/>
	    			<include name="bin/*.jar"/>
	    		</patternset>
	   		</unzip>
    	</sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.pull-in-external-lib          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.pull-in-external-lib">
        <attribute name="name"/>
        <sequential>
            <openscada.pull-in-lib name="external-@{name}"/>
			<append-line file="${module.dep.file}">&quot;${package}&quot; -&gt; &quot;@{name}&quot;</append-line>
        </sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.pull-in-module          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.pull-in-module">
        <attribute name="name" />
        <sequential>
        	<openscada.pull-in-lib name="openscada-@{name}-${tag}"/>
			<append-line file="${module.dep.file}">&quot;${package}&quot; -&gt; &quot;@{name}&quot;</append-line>
        </sequential>
    </macrodef>

	<!-- - - - - - - - - - - - - - - - - - 
          macrodef: openscada.prepare-local-libs  
          Copy the local libraries into the build-lib folder                    
         - - - - - - - - - - - - - - - - - -->
    <macrodef name="openscada.prepare-local-libs">
    	<sequential>
			<copy todir="${build.dir}/${package}/lib" failonerror="false">
				<fileset dir="lib">
					<exclude name="**/.svn"/>
				</fileset>
	    	</copy>
    	</sequential>
    </macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.export.license          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.export.license">
        <sequential>
    		<copy file="COPYING" todir="${build.dir}/${package}"/>
        </sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.export.source          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.export.source">
        <sequential>
    		<mkdir dir="${build.dir}/${package}/src"/>
    		<copy todir="${build.dir}/${package}/src">
    			<fileset dir="src">
    				<exclude name="**/.svn"/>
    			</fileset>
    		</copy>
        </sequential>
    </macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.compile.javadoc          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.compile.javadoc">
        <sequential>
    	   	<mkdir dir="${build.dir}/${package}/docs/api"/>
      		<javadoc destdir="${build.dir}/${package}/docs/api"
    	       	author="true"
    	       	version="true"
    	       	use="true"
    	       	encoding="utf-8"
    	       	>
    	       	<tag name="note" description="Note" scope="all"/>
    	       	<tag name="warning" description="Warning" scope="all"/>
    	       	<packageset dir="src" defaultexcludes="yes">
    	       		<include name="**"/>
    	       	</packageset>
    			<classpath>
    				<fileset dir="${build.dir}/${package}/lib">
    					<include name="*.jar"/>
    				</fileset>
    				<fileset dir="${build.dir}/${package}/bin">
    					<include name="*.jar"/>
    				</fileset>
    	  		</classpath>
    		</javadoc>
        </sequential>
    </macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.compile.source          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.compile.source">
        <sequential>
    		<mkdir dir="${build.dir}/${package}/bin"/>
    		<javac
    			encoding="utf-8"
    			source="1.5"
    			target="1.5"
    			srcdir="src"
    			destdir="${build.dir}/${package}/bin"
    			>
    			<classpath>
    				<fileset dir="${build.dir}/${package}/lib">
    					<include name="**/*.jar"/>
    				</fileset>
       				<fileset dir="${build.dir}/${package}/bin">
       					<include name="*.jar"/>
       				</fileset>
    				<pathelement location="${build.dir}/${package}/schemabin"/>
    			</classpath>
    		</javac>
        </sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.common.build          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.common.build">
        <sequential>
        	<openscada.compile.schema/>
    		<openscada.compile.source/>
    		<openscada.compile.javadoc/>
    		<openscada.export.source/>
    		<openscada.export.license/>
        </sequential>
    </macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.common.deploy          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.common.deploy">
        <sequential>
    		<mkdir dir="${build.dir}/${package}/bin"/>
        	<mkdir dir="${build.dir}/${package}/schemabin"/>
    		<jar destfile="${build.dir}/${package}/bin/openscada-${package}-${tag}.jar">
    			<fileset dir="${build.dir}/${package}/bin">
    				<include name="**/*.class"/>
    			</fileset>
    			<fileset dir="${build.dir}/${package}/schemabin"/>
    		</jar>

    		<mkdir dir="${deploy.dir}"/>
    		<zip basedir="${build.dir}/${package}" destfile="${deploy.dist.module}/openscada-${package}-${tag}.zip">
    			<include name="**/*"/>
    		</zip>
	
			<openscada.export.project/>
        </sequential>
    </macrodef>
	
	<!-- included here to use the same version as used in the build -->
	<taskdef name="xmlbean" classname="org.apache.xmlbeans.impl.tool.XMLBean">
		 <classpath id="xmlbeanspath">
            <pathelement location="${source.base}/external/xmlbeans/xbean.jar"/>
            <pathelement location="${source.base}/external/xmlbeans/jsr173_1.0_api.jar"/>
         </classpath>
	</taskdef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.compile.schema
          Compile the schema files
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.compile.schema">
        <sequential>
        	<if>
        		<available type="dir" file="schema"/>
        		<then>
		        	<mkdir dir="${build.dir}/${package}/schemabin"/>
	    	    	<xmlbean
	   					failonerror="true"
	   					classgendir="${build.dir}/${package}/schemabin"
						javasource="1.5"
			            classpathref="xmlbeanspath"
						>
							<fileset dir="schema" includes="*.xsd"/>
		        	</xmlbean>
        		</then>
        	</if>
		</sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.deploy.external          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.deploy.external">
        <sequential>
        	<mkdir dir="${deploy.dist.module}"/>
        	<zip basedir="${build.dir}/${package}" file="${deploy.dist.module}/external-${package}.zip">
        	</zip>
			<openscada.export.project/>
        </sequential>
    </macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: openscada.export.project          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="openscada.export.project">
        <sequential>
            <xmltask source=".project">
				<copy path="projectDescription/name/text()" property="project.name"/>
			</xmltask>
	
			<!-- copy project files to temp dir -->
			<mkdir dir="${temp.dir}/export-project/${package}/${project.name}"/>
			<copy todir="${temp.dir}/export-project/${package}/${project.name}">
				<fileset dir=".">
					<exclude name="**/.svn"/>
				</fileset>
			</copy>

			<mkdir dir="${deploy.dist.project}"/>
			<zip basedir="${temp.dir}/export-project/${package}" destfile="${deploy.dist.project}/${project.name}-project-${tag}.zip">
			</zip>
	
			<xmltask source="${file.genworkspace}" dest="${file.genworkspace}">
				<insert path="project/target[@name='export-list']" xml="&lt;fetch-and-unpack location=&quot;${url.dist.project}/${project.name}-project-${tag}.zip&quot;/&gt;"/>
			</xmltask>
	
        </sequential>
    </macrodef>

	
</project>
